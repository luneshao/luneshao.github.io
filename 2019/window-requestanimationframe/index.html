<!DOCTYPE html>
<html lang="en-us">
  <head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noodp"/>
  <meta name="author" content="LuneShao">
  <meta name="description" content="这里是lune的个人博客，主要记录了前端开发过程中遇到的问题，欢迎各位大佬进来喝茶。如果文章中有错误的地方，还请各位大佬不吝赐教，万分感谢。">
  <meta name="keywords" content="luneshao，一瓶肥宅快乐水，博客，前端，小骨鱼">
  <meta name="google-site-verification" content="Gu27F60AgLNf8h9KCAXsLXjKd7O-e1oZpSGeblt5w70" />
  <link rel="prev" href="https://luneshao.github.io/2019/css-matrix/" />
  <link rel="next" href="https://luneshao.github.io/2019/css-filter/" />
  <link rel="canonical" href="https://luneshao.github.io/2019/window-requestanimationframe/" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="icon" href="/img/favicon.ico" />
  <link rel="manifest" href="/site.webmanifest">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
  <title>
       
       
           window.requestAnimationFrame方法 | Luneshao
       
  </title>
  <meta name="title" content="window.requestAnimationFrame方法 | Luneshao">
    
  
  <link rel="stylesheet" href="/font/iconfont.css">
  <link rel="stylesheet" href="/css/main.min.css">


  
  
 

<script type="application/ld+json">
 "@context" : "http://schema.org",
    "@type" : "BlogPosting",
    "mainEntityOfPage": {
         "@type": "WebPage",
         "@id": "https:\/\/luneshao.github.io\/"
    },
    "articleSection" : "posts",
    "name" : "window.requestAnimationFrame方法",
    "headline" : "window.requestAnimationFrame方法",
    "description" : "window.requestAnimationFrame方法可以实现setTimeout的功能，经过测试动画会比setTimeout更稳定，并且运行在后台标签页或者隐藏的`\x3ciframe\x3e` 里时会暂停调用，更加节省性能。",
    "inLanguage" : "en-us",
    "author" : "LuneShao",
    "creator" : "LuneShao",
    "publisher": "LuneShao",
    "accountablePerson" : "LuneShao",
    "copyrightHolder" : "LuneShao",
    "copyrightYear" : "2019",
    "datePublished": "2019-05-30 00:00:00 \x2b0000 UTC",
    "dateModified" : "2019-05-30 00:00:00 \x2b0000 UTC",
    "url" : "https:\/\/luneshao.github.io\/2019\/window-requestanimationframe\/",
    "wordCount" : "177",
    "keywords" : [ "前端", "Luneshao"]
}
</script>

  <script src='//unpkg.com/valine/dist/Valine.min.js'></script>
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1858143_e4r74dhzeku.css">
</head>

  


  <body class="">
    <div class="wrapper">
        <nav class="navbar">
    <div class="container">
        <div class="navbar-header header-logo">
        	<a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href="https://luneshao.github.io/">Luneshao</a>
        </div>
        <div class="menu navbar-right">
                
                
                <a class="menu-item" href="/" title="">首页</a>
                
                <a class="menu-item" href="/posts/" title="">Blog</a>
                
                <a class="menu-item" href="/tags/" title="">Tags</a>
                
                <a class="menu-item" href="/about/" title="">About</a>
                
                <a class="menu-item" href="/about/" title=""></a>
                
        </div>
    </div>
</nav>
<nav class="navbar-mobile" id="nav-mobile" style="display: none">
     <div class="container">
        <div class="navbar-header">
            <div>  <a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href="https://luneshao.github.io/">Luneshao</a></div>
            <div class="menu-toggle">
                <span></span><span></span><span></span>
            </div>
        </div>
     
          <div class="menu" id="mobile-menu">
                
                
                <a class="menu-item" href="/" title="">首页</a>
                
                <a class="menu-item" href="/posts/" title="">Blog</a>
                
                <a class="menu-item" href="/tags/" title="">Tags</a>
                
                <a class="menu-item" href="/about/" title="">About</a>
                
                <a class="menu-item" href="/about/" title=""></a>
                
        </div>
    </div>
</nav>
    	 <main class="main">
          <div class="container">
      		
<article class="post-warp" itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
        <h1 class="post-title" itemprop="name headline">window.requestAnimationFrame方法</h1>
        <div class="post-meta">
                Written by <a itemprop="name" href="https://luneshao.github.io/" rel="author">LuneShao</a> with ♥ 
                <span class="post-time">
                on <time datetime=2019-05-30 itemprop="datePublished">May 30, 2019</time>
                </span>
                in
                
                <span id="/2019/window-requestanimationframe/" class="leancloud_visitors post-meta" data-flag-title="window.requestAnimationFrame方法">
                    <span style="font-size: 14px;margin-left: 20px;">本文累计被阅读 <i class="leancloud-visitors-count"></i> 次</span>
                </span>
        </div>
    </header>
    <div class="post-content">
        

        

        
        
     
          
          
          

          
          
          

          

<p><a href="http://web.jobbole.com/91578/" rel="nofollow noreferrer" target="_blank">原文链接伯乐</a>  <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/requestAnimationFrame" rel="nofollow noreferrer" target="_blank">MDN</a></p>

<h2 id="概念">概念</h2>

<p>告诉浏览器——你希望执行一个动画，并且要求浏览器在下次重绘之前调用指定的回调函数更新动画。该方法需要传入一个<strong>回调函数</strong>作为参数，该回调函数会在浏览器下一次重绘之前执行。</p>

<p>个人理解：<strong>raf</strong> 这个函数可以用来做动画，它需要一个参数，参数的形式是一个<strong>回调函数</strong>，在回调函数里可以写需要执行的动画。</p>

<p>这个回调函数会默认接收一个参数，即执行回调函数时的<strong>时间戳</strong>，回调函数，会在每次浏览器在下次重绘前执行回调函数更新动画，个人认为这样来保证动画的帧率和稳定性。大多数电脑显示器的刷新频率是60Hz，大概相当于每秒钟重绘60次，相当于每帧的执行时间为 16.67ms。</p>

<h2 id="特性">特性</h2>

<ul>
<li><p>参数中的回调函数执行次数通常是每秒60次，速度大约为 16.67ms 每帧。</p></li>

<li><p>当<code>requestAnimationFrame()</code>运行在后台标签页或者隐藏的<code>&lt;iframe&gt;</code> 里时，requestAnimationFrame() 会被暂停调用。对比 setTimeout ，离开页面依旧会计时，raf 更加节省性能。</p></li>

<li><p><strong>DOMHighResTimeStamp</strong>指示由 <code>RequestAnimationFrame()</code> 排队的回调开始触发的时间。</p></li>

<li><p>它返回一个整数，表示定时器的编号，这个值可以传递给 <code>cancelAnimationFrame</code> 用于取消这个函数的执行。</p></li>
</ul>

<h2 id="使用方法">使用方法</h2>

<pre><code class="language-js">window.requestAnimationFrame(callback)

function callback (timeStamp) {
  // 默认接收参数 timeStamp，表示开始执行回调函数的时刻

  // 若你想在浏览器下次重绘之前继续更新下一帧动画，那么回调函数自身必须再次调用window.requestAnimationFrame()
  window.requestAnimationFrame(callback)
}
</code></pre>

<h2 id="避免一帧多次调用">避免一帧多次调用</h2>

<pre><code class="language-js">  let ifCurFra = false // 当前帧是否执行
  function cb (timeStamp) {
    if (ifCurFra) return 
    ifCurFra = true
    window.requestAnimationFrame(timeStamp =&gt; {
      ifCurFra = false
    })
  }

  window.addEventListener('scroll', cb)
</code></pre>

<h2 id="兼容">兼容</h2>

<p><a href="https://www.cnblogs.com/xiaohuochai/p/5777186.html" rel="nofollow noreferrer" target="_blank">兼容代码</a></p>

<pre><code class="language-js">if(!window.requestAnimationFrame){
  var lastTime = 0;
  window.requestAnimationFrame = function(callback){
      var currTime = new Date().getTime();
      var timeToCall = Math.max(0,16.7-(currTime - lastTime));
      var id  = window.setTimeout(function(){
          callback(currTime + timeToCall);
      },timeToCall);
      lastTime = currTime + timeToCall;
      return id;
  }
}
</code></pre>

<h2 id="example">example</h2>

<p>我测试了一下两种方法实现动画，认为 setTimeout() 和 window.requestAnimationFrame ()， raf 的动画更稳定一些,sto 有时平稳有时抖动。</p>

<p>sto 抖动的原因：假设屏幕每隔16.7ms刷新一次，而setTimeout每隔10ms设置图像向左移动1px， 就会引起动画卡顿。</p>

<pre><code class="language-js">// 测试文件相关部分代码
  const el = document.querySelector('.box1')
  let start = null
  let ml = 0
  const totalTime = 2000
  
  function ani (timeStamp) {
    if (!start) {
      start = timeStamp
    }

    const progress = timeStamp - start
    // 判断时间差（时间间隔），是否是规定时间
    if (progress &lt; totalTime) {
      el.style.left = `${ml++}px`
      window.requestAnimationFrame(ani)
    }
  }

  window.requestAnimationFrame(ani)
</code></pre>

<p>附上我的<a href="https://codepen.io/LuneShao/project/editor/XMbnnx" rel="nofollow noreferrer" target="_blank">测试文件</a></p>

<p>文件中存在一个问题，我的定时器是2s，结束时的时间大部分是 1985ms, 可能因为函数执行的速度是每帧 16.7ms，1985 + 16.7 &gt; 2000 最后一次的判断就是 false 了，就没有执行2000ms，在我的例子中实际上就少加了 1px。还请各位大佬多多指教。</p>

<blockquote>
<p>以上。🧐</p>
</blockquote>

    </div>

    <div class="post-copyright">
             
            <p class="copyright-item">
                <span>Author:</span>
                <span>LuneShao </span>
                </p>
            
           
             
            <p class="copyright-item">
                    <span>Link:</span>
                    <a href=https://luneshao.github.io/2019/window-requestanimationframe/>https://luneshao.github.io/2019/window-requestanimationframe/</span>
            </p>
            
             
            <p class="copyright-item lincese">
                本文采用<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可
            </p>
            
    </div>
  
    <div class="post-tags">
        
            <section>
            <i class="iconfont icon-tag"></i>Tag(s): 
            
            <span class="tag"><a href="https://luneshao.github.io/tags/%E5%89%8D%E7%AB%AF/">
                    #前端</a></span>
            
            </section>
        
        <section>
                <a href="javascript:window.history.back();">back</a></span> · 
                <span><a href="https://luneshao.github.io/">home</a></span>
        </section>
    </div>

    <div class="post-nav">
        
        <a href="https://luneshao.github.io/2019/css-matrix/" class="prev" rel="prev" title="CSS Tranform 的 Matrix函数"><i class="iconfont icon-left"></i>&nbsp;CSS Tranform 的 Matrix函数</a>
         
        
        <a href="https://luneshao.github.io/2019/css-filter/" class="next" rel="next" title="强大的css filter属性及色彩名词（附 opacity 属性的兼容写法）">强大的css filter属性及色彩名词（附 opacity 属性的兼容写法）&nbsp;<i class="iconfont icon-right"></i></a>
        
    </div>

    <div class="post-comment">
        <div id="vcomment"></div>
          
                 
          
    </div>
    <script>
        new Valine({
          el: '#vcomment' ,
          appId: 'VMtRNdHhQOQVoiWu2y2dQnJb-gzGzoHsz',
          appKey: '073437m7LGtKY9mmCQioFbKI',
          notify:true, 
          verify:false, 
          avatar:'wavatar', 
          recordIP: true,
          visitor: true, 
          placeholder: '你好哇，快来戳我吐槽吧！🎉' 
        })
    </script>
</article>
          </div>
		   </main>
      <footer class="footer">
    <div class="copyright">
        &copy;
        
        <span itemprop="copyrightYear">2019 - 2020</span>
        
        <span class="with-love">
    	 <i class="iconfont icon-love"></i> 
         </span>
         
            <span class="author" itemprop="copyrightHolder"><a href="https://luneshao.github.io/">LuneShao</a> | </span> 
         

         
		  <span>Powered by <a href="https://gohugo.io/" target="_blank" rel="external nofollow">Hugo</a> & <a href="https://github.com/liuzc/leaveit" target="_blank" rel="external nofollow">LeaveIt</a></span> 
    </div>
</footer>












    
    
    <script src="/js/vendor_no_gallery.min.js" async=""></script>
    
  



     </div>
  </body>
</html>
